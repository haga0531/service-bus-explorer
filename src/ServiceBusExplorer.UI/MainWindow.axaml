<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:ServiceBusExplorer.UI"
        xmlns:models="clr-namespace:ServiceBusExplorer.Core.Models;assembly=ServiceBusExplorer.Core"
        xmlns:view="clr-namespace:ServiceBusExplorer.UI"
        x:Class="ServiceBusExplorer.UI.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Width="1400" Height="900" 
        MinWidth="1000" MinHeight="600"
        Title="Service Bus Explorer">

    <Window.Styles>
        <Style Selector="TreeViewItem">
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.2" />
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" />
                </Transitions>
            </Setter>
            <Setter Property="Padding" Value="2" />
        </Style>
        <Style Selector="TreeViewItem:pointerover /template/ Border#PART_Border">
            <Setter Property="Background" Value="#E8E8E8" />
        </Style>
        <Style Selector="TreeViewItem:selected /template/ Border#PART_Border">
            <Setter Property="Background" Value="#0078D4" />
        </Style>
        <Style Selector="TreeViewItem:selected TextBlock">
            <Setter Property="Foreground" Value="White" />
        </Style>
    </Window.Styles>

    <Grid>
        <!-- Main layout with log panel at bottom -->
        <Grid RowDefinitions="*,5,200">
            <!-- Main content area -->
            <Grid Grid.Row="0" RowDefinitions="Auto,*" ColumnDefinitions="320,5,*">
            <!-- Toolbar -->
            <StackPanel Orientation="Horizontal" Spacing="6" Margin="8"
                        Grid.Row="0" Grid.ColumnSpan="3">
                <Button Content="Connect" Command="{Binding ConnectCommand}" />
            </StackPanel>

            <!-- Left: Namespace Tree -->
            <Border Grid.Row="1" Grid.Column="0" 
                    BorderBrush="LightGray" BorderThickness="0,0,1,0">
                <Grid>
                    <!-- TreeView Content -->
                    <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                                  VerticalScrollBarVisibility="Auto"
                                  IsVisible="{Binding !IsConnecting}">
                        <TreeView x:Name="NamespaceTreeView"
                                  ItemsSource="{Binding Nodes}"
                                  SelectedItem="{Binding SelectedNode, Mode=TwoWay}"
                                  Padding="4"
                                  ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <TreeView.ItemTemplate>
                            <TreeDataTemplate DataType="models:NamespaceNode"
                                              ItemsSource="{Binding Children}">
                                <StackPanel Orientation="Horizontal" Spacing="5">
                                    <TextBlock Text="{Binding Icon}" 
                                               VerticalAlignment="Center"
                                               FontSize="14" />
                                    <TextBlock Text="{Binding DisplayName}" 
                                               VerticalAlignment="Center"
                                               Padding="2"
                                               FontSize="12"
                                               TextTrimming="CharacterEllipsis"
                                               ToolTip.Tip="{Binding DisplayName}">
                                        <TextBlock.Styles>
                                            <Style Selector="TextBlock[Tag=True]">
                                                <Setter Property="Opacity" Value="0.6" />
                                                <Setter Property="FontStyle" Value="Italic" />
                                            </Style>
                                        </TextBlock.Styles>
                                        <TextBlock.Tag>
                                            <Binding Path="HasAutoForwarding" />
                                        </TextBlock.Tag>
                                    </TextBlock>
                                </StackPanel>
                            </TreeDataTemplate>
                        </TreeView.ItemTemplate>
                        </TreeView>
                    </ScrollViewer>
                    
                    <!-- Loading indicator for TreeView -->
                    <Border Background="#F5F5F5"
                            IsVisible="{Binding IsConnecting}">
                        <StackPanel VerticalAlignment="Center"
                                    HorizontalAlignment="Center"
                                    Spacing="10">
                            <ProgressBar IsIndeterminate="True"
                                         Width="100"
                                         Height="4" />
                            <TextBlock Text="{Binding ConnectionProgress}"
                                       HorizontalAlignment="Center"
                                       Foreground="Gray" />
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>

            <!-- Splitter -->
            <GridSplitter Grid.Row="1" Grid.Column="1" 
                          Width="5" 
                          HorizontalAlignment="Stretch"
                          Background="LightGray" />

            <!-- Right: Message List -->
            <Grid Grid.Row="1" Grid.Column="2">
                <!-- Message list container -->
                <Panel IsVisible="{Binding MessageList, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <view:MessageListView DataContext="{Binding MessageList}" />
                </Panel>
                
                <!-- Not connected message -->
                <TextBlock Text="Connect to a Service Bus namespace to view messages"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Foreground="Gray"
                           FontSize="16"
                           IsVisible="{Binding MessageList, Converter={x:Static ObjectConverters.IsNull}}" />
            </Grid>
        </Grid>
        
        <!-- Error Message Banner -->
        <Border Background="#FFCC0000" 
                Padding="10,5"
                VerticalAlignment="Top"
                HorizontalAlignment="Stretch"
                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Text="{Binding ErrorMessage}" 
                           Foreground="White"
                           TextWrapping="Wrap"
                           VerticalAlignment="Center" />
                <Button Grid.Column="1" 
                        Content="âœ•"
                        Background="Transparent"
                        Foreground="White"
                        BorderThickness="0"
                        Padding="5,0"
                        Command="{Binding ClearErrorCommand}" />
            </Grid>
        </Border>
            
            <!-- Splitter between main content and log panel -->
            <GridSplitter Grid.Row="1" 
                          Height="5"
                          HorizontalAlignment="Stretch"
                          Background="LightGray" />
            
            <!-- Log panel -->
            <view:LogView Grid.Row="2" 
                          DataContext="{Binding LogViewModel}" />
        </Grid>
    </Grid>
</Window>
